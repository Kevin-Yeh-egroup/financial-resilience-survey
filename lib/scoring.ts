import type { QuestionnaireResult, DimensionScores, StructureType, AnimalType } from "@/types/questionnaire"

export function calculateResult(answers: Record<number, number>): QuestionnaireResult {
  // è¨ˆç®—ç¸½åˆ†ï¼ˆ0-100ï¼‰
  const totalScore = Object.values(answers).reduce((sum, score) => sum + score, 0)

  // è¨ˆç®—å…­æ§‹é¢åˆ†æ•¸ï¼ˆ0-30ï¼‰ï¼šç›´æ¥åŠ ç¸½ï¼Œä¸é™¤ä»¥2ä¹Ÿä¸ä¹˜ä»¥10
  // æ ¹æ“šå…­å¤§æŒ‡æ¨™ Ã— é¡Œç›®å°æ‡‰è¡¨ï¼ˆæœ€çµ‚ç‰ˆï¼‰
  const dimensionScores: DimensionScores = {
    // â‘  æ”¶å…¥ç©©å®šåº¦ï¼šç¬¬ 1ã€2ã€9 é¡Œ
    æ”¶å…¥ç©©å®šåº¦: (answers[1] || 0) + (answers[2] || 0) + (answers[9] || 0),
    // â‘¡ å„²å‚™æ‡‰è®ŠåŠ›ï¼šç¬¬ 1ã€3ã€5 é¡Œ
    å„²å‚™æ‡‰è®ŠåŠ›: (answers[1] || 0) + (answers[3] || 0) + (answers[5] || 0),
    // â‘¢ å‚µå‹™èˆ‡ä¿éšœï¼šç¬¬ 4ã€6ã€10 é¡Œ
    å‚µå‹™èˆ‡ä¿éšœ: (answers[4] || 0) + (answers[6] || 0) + (answers[10] || 0),
    // â‘£ é‡‘éŒ¢ç®¡ç†ï¼šç¬¬ 3ã€7ã€8 é¡Œ
    é‡‘éŒ¢ç®¡ç†: (answers[3] || 0) + (answers[7] || 0) + (answers[8] || 0),
    // â‘¤ è³‡æºé€£çµï¼šç¬¬ 5ã€7ã€9 é¡Œ
    è³‡æºé€£çµ: (answers[5] || 0) + (answers[7] || 0) + (answers[9] || 0),
    // â‘¥ å¿ƒç†èˆ‡è¦åŠƒï¼šç¬¬ 3ã€8ã€10 é¡Œ
    å¿ƒç†èˆ‡è¦åŠƒ: (answers[3] || 0) + (answers[8] || 0) + (answers[10] || 0),
  }

  // åˆ¤æ–·çµæ§‹å‹ï¼ˆå„ªå…ˆè¦†è“‹åˆ¶ï¼Œç”±æœ€è„†å¼±åˆ°æœ€æˆç†Ÿï¼‰
  const structureType = determineStructureType(dimensionScores, answers)

  // åˆ¤æ–·ç‹€æ…‹ç†è§£å‹•ç‰©ï¼ˆ8 é¡ï¼‰
  const animalType = determineAnimalType(dimensionScores, answers)

  // åˆ¤æ–·ç­‰ç´šï¼ˆç”¨æ–¼é¡è‰²é¡¯ç¤ºï¼‰
  let level: QuestionnaireResult["level"]
  if (totalScore >= 75) {
    level = "resilient"
  } else if (totalScore >= 60) {
    level = "approaching"
  } else if (totalScore >= 40) {
    level = "fragile"
  } else {
    level = "highly-fragile"
  }

  const priorities = determinePriorities(answers)

  return {
    totalScore,
    level,
    priorities,
    dimensionScores,
    structureType,
    animalType,
  }
}

function determineStructureType(
  dimensions: DimensionScores,
  answers: Record<number, number>
): StructureType {
  // ============================================
  // ã€é›™å±¤çµæ§‹æ‰¿æ¥åˆ¤è®€æ³•ï¼ˆDSRMï¼‰â€” ç³»çµ±åˆ¤è®€ç¸½åŸå‰‡ã€‘
  // ============================================
  // ç¬¬ä¸€å±¤ï¼šåš´æ ¼çµæ§‹åˆ¤è®€ï¼ˆStrict Classificationï¼‰
  // - æ¯ä¸€å€‹çµæ§‹å‹æ…‹çš†æœ‰æ˜ç¢ºã€Œå¿…è¦æ¢ä»¶ã€èˆ‡ã€Œå¦æ±ºæ¢ä»¶ã€
  // - åƒ…åœ¨å®Œå…¨ç¬¦åˆæ¢ä»¶æ™‚ï¼Œæ‰å¯åˆ¤å®šç‚ºè©²çµæ§‹
  // - è‹¥ç„¡ä»»ä½•çµæ§‹å‘½ä¸­ï¼Œå…è¨±æš«æ™‚é€²å…¥ç³»çµ±å…§éƒ¨ç‹€æ…‹ UNCLASSIFIEDï¼ˆåƒ…é™å…§éƒ¨ï¼‰
  //
  // ç¬¬äºŒå±¤ï¼šæ‰¿æ¥å±¤åˆ¤è®€ï¼ˆFallback Resolutionï¼‰
  // - è‹¥ç¬¬ä¸€å±¤ç„¡å‘½ä¸­ï¼Œç³»çµ±ä¸å¾—å°ä½¿ç”¨è€…é¡¯ç¤ºã€Œç„¡æ³•å®šç¾©ã€
  // - å¿…é ˆé€éæ‰¿æ¥é‚è¼¯ï¼Œå°‡çµæœæ˜ å°„ç‚ºã€Œæœ€æ¥è¿‘çš„çµæ§‹å‹æ…‹ã€
  // - æ‰¿æ¥å±¤ä¸å¾—ä¿®æ”¹åŸå§‹åˆ†æ•¸æˆ–ç‡ˆè™Ÿï¼Œåªèƒ½ä¾æ—¢æœ‰çµæ§‹é€²è¡Œæ¯”å°
  //
  // å°ä½¿ç”¨è€…ç«¯ï¼š
  // - ç³»çµ±æ°¸é åªè¼¸å‡ºä¸€å€‹å¯ç†è§£çš„çµæ§‹å‹æ…‹
  // - ä¸é¡¯ç¤º UNCLASSIFIEDã€ä¸é¡¯ç¤ºéŒ¯èª¤æˆ–ä¾‹å¤–
  // ============================================

  const {
    æ”¶å…¥ç©©å®šåº¦,
    å„²å‚™æ‡‰è®ŠåŠ›,
    å‚µå‹™èˆ‡ä¿éšœ,
    é‡‘éŒ¢ç®¡ç†,
    è³‡æºé€£çµ,
    å¿ƒç†èˆ‡è¦åŠƒ,
  } = dimensions

  // åˆ†æ•¸å€é–“å®šç¾©ï¼ˆç‡ˆè™Ÿç³»çµ±ï¼‰
  // ğŸ”´ 0â€“7ï¼šçµæ§‹æ–·è£‚æˆ–é«˜åº¦ä¸è¶³
  // ğŸŸ  8â€“15ï¼šæ˜é¡¯åƒåŠ›ï¼Œå®‰å…¨é‚Šéš›è–„
  // ğŸŸ¡ 16â€“23ï¼šå¯é‹ä½œä½†å½ˆæ€§æœ‰é™
  // ğŸŸ¢ 24â€“30ï¼šçµæ§‹è‰¯å¥½ï¼Œå¯æ‰¿æ¥è®Šå‹•

  // è¼”åŠ©å‡½æ•¸ï¼šåˆ¤æ–·åˆ†æ•¸å€é–“
  const isRed = (score: number) => score >= 0 && score <= 7
  const isOrange = (score: number) => score >= 8 && score <= 15
  const isYellow = (score: number) => score >= 16 && score <= 23
  const isGreen = (score: number) => score >= 24 && score <= 30
  const isOrangeOrRed = (score: number) => score >= 0 && score <= 15
  const isYellowOrGreen = (score: number) => score >= 16 && score <= 30

  const allDimensions = [æ”¶å…¥ç©©å®šåº¦, å„²å‚™æ‡‰è®ŠåŠ›, å‚µå‹™èˆ‡ä¿éšœ, é‡‘éŒ¢ç®¡ç†, è³‡æºé€£çµ, å¿ƒç†èˆ‡è¦åŠƒ]
  const redCount = allDimensions.filter((d) => isRed(d)).length
  const orangeCount = allDimensions.filter((d) => isOrange(d)).length
  const supportDimensions = [å„²å‚™æ‡‰è®ŠåŠ›, è³‡æºé€£çµ, å¿ƒç†èˆ‡è¦åŠƒ]

  // ============================================
  // ã€çµæ§‹åˆ¤è®€é †åºï¼ˆä¸å¯æ›´å‹•ï¼‰ã€‘
  // ç³»çµ±åˆ¤è®€æ™‚ï¼Œå¿…é ˆä¾ä¸‹åˆ—é †åºæª¢æŸ¥çµæ§‹ï¼Œç¬¦åˆå³åœæ­¢ï¼š
  // 1. å¾ªç’°æ¶ˆè€—å‹ï¼ˆStrict onlyï¼‰
  // 2. å–®ä¸€æ”¯æ’å‹ï¼ˆStrict onlyï¼‰
  // 3. åƒåŠ›æ”¯æ’å‹ï¼ˆStrict + æ‰¿æ¥ï¼‰
  // 4. è³‡æºå¡ä½å‹ï¼ˆStrict + æ‰¿æ¥ï¼‰
  // 5. äººè„ˆæ‰¿æ¥å‹ï¼ˆStrict + æ‰¿æ¥ï¼‰
  // 6. æ—¥å¸¸ç©©å®šå‹ï¼ˆStrictï¼‰
  // 7. æˆé•·å»ºæ§‹å‹ï¼ˆStrict + æ‰¿æ¥ï¼‰
  // 8. æˆç†Ÿç©©å¥å‹ï¼ˆStrict onlyï¼‰
  // ============================================

  // ç¬¬ä¸€å±¤ï¼šåš´æ ¼çµæ§‹åˆ¤è®€ï¼ˆStrict Classificationï¼‰

  // 1. å¾ªç’°æ¶ˆè€—ï¼ˆcycleï¼‰
  // ç‡ˆè™Ÿæ¢ä»¶ï¼ˆå¿…è¦åˆ¤å®šï¼‰ï¼š
  // - å„²å‚™æ‡‰è®ŠåŠ›ï¼šğŸ”´
  // - å‚µå‹™èˆ‡ä¿éšœï¼šğŸ”´
  // - ä»¥ä¸‹ä¸‰é …ä¸­ï¼Œè‡³å°‘ä¸€é …ç‚º ğŸŸ  æˆ– ğŸ”´ï¼šé‡‘éŒ¢ç®¡ç†ã€å¿ƒç†èˆ‡è¦åŠƒã€è³‡æºé€£çµ
  // æ’é™¤æ¢ä»¶ï¼š
  // - è‹¥å„²å‚™æ‡‰è®ŠåŠ› â‰  ğŸ”´ æˆ– å‚µå‹™èˆ‡ä¿éšœ â‰  ğŸ”´ï¼Œä¸å¾—åˆ¤ç‚ºå¾ªç’°æ¶ˆè€—å‹
  // - è‹¥è³‡æºé€£çµ = ğŸŸ¢ï¼Œä¸å¾—åˆ¤ç‚ºå¾ªç’°æ¶ˆè€—å‹ï¼ˆæœ‰å¤–éƒ¨æ”¯æŒç³»çµ±ï¼Œå£“åŠ›ä¸å†å®Œå…¨ç”±å®¶åº­å…§éƒ¨æ‰¿æ“”ï¼‰
  if (
    !isGreen(è³‡æºé€£çµ) && // æ’é™¤ï¼šè³‡æºé€£çµ = ğŸŸ¢
    isRed(å„²å‚™æ‡‰è®ŠåŠ›) &&
    isRed(å‚µå‹™èˆ‡ä¿éšœ) &&
    (isOrangeOrRed(é‡‘éŒ¢ç®¡ç†) || isOrangeOrRed(å¿ƒç†èˆ‡è¦åŠƒ) || isOrangeOrRed(è³‡æºé€£çµ))
  ) {
    return "cycle"
  }

  // 2. å–®ä¸€æ”¯æ’ï¼ˆsingleï¼‰
  // ç‡ˆè™Ÿæ¢ä»¶ï¼ˆå¿…è¦åˆ¤å®šï¼‰ï¼š
  // - æ”¶å…¥ç©©å®šåº¦ï¼šğŸŸ¢
  // - ä»¥ä¸‹ä¸‰é …ä¸­ï¼Œè‡³å°‘å…©é …ç‚º ğŸŸ  æˆ– ğŸ”´ï¼šå„²å‚™æ‡‰è®ŠåŠ›ã€è³‡æºé€£çµã€å¿ƒç†èˆ‡è¦åŠƒ
  // æ–°å¢çµæ§‹é™åˆ¶æ¢ä»¶ï¼šå¿ƒç†èˆ‡è¦åŠƒ â‰  ğŸ”´ï¼ˆè‹¥å¿ƒç†å·²ç´…ç‡ˆï¼Œä»£è¡¨å‹•èƒ½æ–·è£‚ï¼Œä¸å¾—è¦–ç‚ºå¯æ’å‹æ…‹ï¼‰
  // æ’é™¤æ¢ä»¶ï¼š
  // - è‹¥å„²å‚™æ‡‰è®ŠåŠ› â‰¥ ğŸŸ¡ ä¸” è³‡æºé€£çµ â‰¥ ğŸŸ¡ï¼Œä¸å¾—åˆ¤ç‚ºå–®ä¸€æ”¯æ’å‹
  // - è‹¥è³‡æºé€£çµ = ğŸŸ¢ï¼Œä¸å¾—åˆ¤ç‚ºå–®ä¸€æ”¯æ’å‹ï¼ˆæœ‰å¤–éƒ¨æ”¯æŒç³»çµ±ï¼Œå£“åŠ›ä¸å†å®Œå…¨ç”±å®¶åº­å…§éƒ¨æ‰¿æ“”ï¼‰
  if (isGreen(æ”¶å…¥ç©©å®šåº¦) && !isGreen(è³‡æºé€£çµ)) { // æ’é™¤ï¼šè³‡æºé€£çµ = ğŸŸ¢
    const supportLowCount = [å„²å‚™æ‡‰è®ŠåŠ›, è³‡æºé€£çµ, å¿ƒç†èˆ‡è¦åŠƒ].filter((d) => isOrangeOrRed(d)).length
    if (
      supportLowCount >= 2 &&
      !isRed(å¿ƒç†èˆ‡è¦åŠƒ) && // æ–°å¢ï¼šå¿ƒç†èˆ‡è¦åŠƒ â‰  ğŸ”´
      !(isYellowOrGreen(å„²å‚™æ‡‰è®ŠåŠ›) && isYellowOrGreen(è³‡æºé€£çµ)) // æ’é™¤ï¼šè‹¥å„²å‚™æ‡‰è®ŠåŠ› â‰¥ ğŸŸ¡ ä¸” è³‡æºé€£çµ â‰¥ ğŸŸ¡
    ) {
      return "single"
    }
  }

  // 3. åƒåŠ›æ”¯æ’ï¼ˆstrugglingï¼‰
  // ç‡ˆè™Ÿæ¢ä»¶ï¼ˆå¿…è¦åˆ¤å®šï¼‰ï¼š
  // - å„²å‚™æ‡‰è®ŠåŠ›ï¼šğŸŸ 
  // - é‡‘éŒ¢ç®¡ç†ï¼šğŸŸ 
  // - å¿ƒç†èˆ‡è¦åŠƒï¼šğŸŸ ï¼ˆé™å®šï¼‰
  // - å…­å¤§æŒ‡æ¨™ä¸­ ğŸ”´ ä¸å¾—è¶…éä¸€é …
  // æ’é™¤æ¢ä»¶ï¼š
  // - è‹¥ ğŸ”´ â‰¥ 2 é …ï¼Œæ‡‰å›åˆ¤ç‚ºã€Œå¾ªç’°æ¶ˆè€—å‹ã€ï¼ˆå·²åœ¨å¾ªç’°æ¶ˆè€—ä¹‹å¾Œæª¢æŸ¥ï¼‰
  // - è‹¥è³‡æºé€£çµ = ğŸŸ¢ï¼Œä¸å¾—åˆ¤ç‚ºåƒåŠ›æ”¯æ’å‹ï¼ˆæœ‰å¤–éƒ¨æ”¯æŒç³»çµ±ï¼Œå£“åŠ›ä¸å†å®Œå…¨ç”±å®¶åº­å…§éƒ¨æ‰¿æ“”ï¼‰
  if (
    !isGreen(è³‡æºé€£çµ) && // æ’é™¤ï¼šè³‡æºé€£çµ = ğŸŸ¢
    isOrange(å„²å‚™æ‡‰è®ŠåŠ›) &&
    isOrange(é‡‘éŒ¢ç®¡ç†) &&
    isOrange(å¿ƒç†èˆ‡è¦åŠƒ) && // æ”¹ç‚ºé™å®šï¼šå¿ƒç†èˆ‡è¦åŠƒï¼šğŸŸ ï¼ˆä¸å†åŒ…å«ğŸŸ¡ï¼‰
    redCount <= 1
  ) {
    return "struggling"
  }

  // 4. è³‡æºå¡ä½ï¼ˆstuckï¼‰
  // ç‡ˆè™Ÿæ¢ä»¶ï¼š
  // - æ”¶å…¥ç©©å®šåº¦ï¼šğŸŸ¡ï½ğŸŸ¢
  // - ä»¥ä¸‹è‡³å°‘å…©é …ç‚º ğŸŸ  æˆ– ğŸ”´ï¼šå„²å‚™æ‡‰è®ŠåŠ›ã€é‡‘éŒ¢ç®¡ç†ã€å¿ƒç†èˆ‡è¦åŠƒ
  // - è³‡æºé€£çµï¼šğŸŸ¡ æˆ– ğŸŸ¢ï¼ˆè³‡æºå­˜åœ¨ï¼Œä½†æœªå½¢æˆå¯¦è³ªæ‰¿æ¥ï¼‰
  // æ–°å¢å¦æ±ºæ¢ä»¶ï¼šè‹¥å„²å‚™æ‡‰è®ŠåŠ›ï¼ğŸ”´ ä¸” å¿ƒç†èˆ‡è¦åŠƒï¼ğŸ”´ â†’ ä¸å¾—åˆ¤ç‚ºè³‡æºå¡ä½å‹ï¼ˆä»£è¡¨å·²ç„¡å‹•èƒ½ï¼Œæ‡‰ä¸Šåˆ¤å¾ªç’°æ¶ˆè€—ï¼‰
  // æ’é™¤æ¢ä»¶ï¼šè‹¥è³‡æºé€£çµï¼šğŸŸ¢ ä¸” å¿ƒç†èˆ‡è¦åŠƒï¼šğŸŸ¢ï¼Œæ‡‰å¾€ä¸Šæª¢æŸ¥ã€Œäººè„ˆæ‰¿æ¥å‹ã€ï¼ˆå·²åœ¨äººè„ˆæ‰¿æ¥ä¹‹å¾Œæª¢æŸ¥ï¼‰
  if (
    (isYellow(æ”¶å…¥ç©©å®šåº¦) || isGreen(æ”¶å…¥ç©©å®šåº¦)) &&
    (isYellow(è³‡æºé€£çµ) || isGreen(è³‡æºé€£çµ))
  ) {
    const weakDimensions = [å„²å‚™æ‡‰è®ŠåŠ›, é‡‘éŒ¢ç®¡ç†, å¿ƒç†èˆ‡è¦åŠƒ]
    const weakCount = weakDimensions.filter((d) => isOrangeOrRed(d)).length
    if (
      weakCount >= 2 &&
      !(isRed(å„²å‚™æ‡‰è®ŠåŠ›) && isRed(å¿ƒç†èˆ‡è¦åŠƒ)) && // æ–°å¢å¦æ±ºï¼šè‹¥å„²å‚™æ‡‰è®ŠåŠ›ï¼ğŸ”´ ä¸” å¿ƒç†èˆ‡è¦åŠƒï¼ğŸ”´ â†’ ä¸å¾—åˆ¤ç‚ºè³‡æºå¡ä½å‹
      !(isGreen(è³‡æºé€£çµ) && isGreen(å¿ƒç†èˆ‡è¦åŠƒ))  // é¿å…èˆ‡äººè„ˆæ‰¿æ¥é‡ç–Š
    ) {
      return "stuck"
    }
  }

  // 5. äººè„ˆæ‰¿æ¥ï¼ˆsupportedï¼‰
  // ç‡ˆè™Ÿæ¢ä»¶ï¼š
  // - è³‡æºé€£çµï¼šğŸŸ¢
  // - å¿ƒç†èˆ‡è¦åŠƒï¼šğŸŸ¢
  // çµæ§‹é™åˆ¶æ¢ä»¶ï¼š
  // - ä»¥ä¸‹å››é …ä¸­ï¼Œè‡³å°‘å…©é …ç‚º ğŸŸ ï¼Œä¸”æœ€å¤šåƒ…ä¸€é …ç‚º ğŸŸ¢ï¼šæ”¶å…¥ç©©å®šåº¦ã€å„²å‚™æ‡‰è®ŠåŠ›ã€å‚µå‹™èˆ‡ä¿éšœã€é‡‘éŒ¢ç®¡ç†
  // - å„²å‚™æ‡‰è®ŠåŠ› â‰¤ ğŸŸ¡ï¼ˆå°šæœªå…§å»ºå®‰å…¨é‚Šéš›ï¼‰
  // - å‚µå‹™èˆ‡ä¿éšœ â‰  ğŸ”´ï¼ˆæ–°å¢ï¼‰
  // æ’é™¤æ¢ä»¶ï¼šè‹¥ä»¥ä¸‹ä¸‰é …ä¸­ä»»å…©é …ç‚º ğŸŸ¢ï¼šå„²å‚™æ‡‰è®ŠåŠ›ã€é‡‘éŒ¢ç®¡ç†ã€å‚µå‹™èˆ‡ä¿éšœï¼Œä¸å¾—åˆ¤ç‚ºäººè„ˆæ‰¿æ¥å‹
  if (isGreen(è³‡æºé€£çµ) && isGreen(å¿ƒç†èˆ‡è¦åŠƒ)) {
    // å„²å‚™æ‡‰è®ŠåŠ› â‰¤ ğŸŸ¡ï¼ˆå°šæœªå…§å»ºå®‰å…¨é‚Šéš›ï¼‰
    if (!isGreen(å„²å‚™æ‡‰è®ŠåŠ›) && !isRed(å‚µå‹™èˆ‡ä¿éšœ)) { // æ–°å¢ï¼šå‚µå‹™èˆ‡ä¿éšœ â‰  ğŸ”´
      const otherDimensions = [æ”¶å…¥ç©©å®šåº¦, å„²å‚™æ‡‰è®ŠåŠ›, å‚µå‹™èˆ‡ä¿éšœ, é‡‘éŒ¢ç®¡ç†]
      const orangeCount = otherDimensions.filter((d) => isOrange(d)).length
      const greenCount = otherDimensions.filter((d) => isGreen(d)).length
      
      // è‡³å°‘å…©é …ç‚º ğŸŸ ï¼Œä¸”æœ€å¤šåƒ…ä¸€é …ç‚º ğŸŸ¢
      if (orangeCount >= 2 && greenCount <= 1) {
        // æ’é™¤æ¢ä»¶ï¼šè‹¥ä»¥ä¸‹ä¸‰é …ä¸­ä»»å…©é …ç‚º ğŸŸ¢ï¼Œå‰‡ä¸å¾—åˆ¤ç‚ºäººè„ˆæ‰¿æ¥å‹
        const criticalDimensions = [å„²å‚™æ‡‰è®ŠåŠ›, é‡‘éŒ¢ç®¡ç†, å‚µå‹™èˆ‡ä¿éšœ]
        const criticalGreenCount = criticalDimensions.filter((d) => isGreen(d)).length
        if (criticalGreenCount < 2) {
          return "supported"
        }
      }
    }
  }

  // 6. æ—¥å¸¸ç©©å®šï¼ˆstableï¼‰
  // ç‡ˆè™Ÿæ¢ä»¶ï¼ˆå¿…è¦ï¼‰ï¼š
  // - æ”¶å…¥ç©©å®šåº¦ï¼šğŸŸ¡ï½ğŸŸ¢
  // - é‡‘éŒ¢ç®¡ç†ï¼šğŸŸ¡
  // - å¿ƒç†èˆ‡è¦åŠƒï¼šğŸŸ¡
  // - å„²å‚™æ‡‰è®ŠåŠ›ï¼šğŸŸ ï½ğŸŸ¡
  // - è³‡æºé€£çµï¼šğŸŸ ï½ğŸŸ¡
  // - å…­å¤§æŒ‡æ¨™ä¸­ ğŸ”´ ä¸å¾—è¶…éä¸€é …
  // - ä¸”å¿ƒç†ã€é‡‘éŒ¢ç®¡ç†ã€å„²å‚™ä¸å¾—ç‚º ğŸ”´ï¼ˆæ–°å¢å¦æ±ºï¼‰
  // æ’é™¤æ¢ä»¶ï¼š
  // - è‹¥ ğŸ”´ â‰¥ 2 é …ï¼Œæ‡‰å›åˆ¤ç‚ºã€ŒåƒåŠ›æ”¯æ’å‹ã€ï¼ˆå·²åœ¨åƒåŠ›æ”¯æ’ä¹‹å¾Œæª¢æŸ¥ï¼‰
  // - è‹¥å¿ƒç†èˆ‡è¦åŠƒï¼šğŸŸ¢ ä¸” é‡‘éŒ¢ç®¡ç†ï¼šğŸŸ¢ï¼Œæ‡‰å¾€ä¸Šæª¢æŸ¥ã€Œæˆé•·å»ºæ§‹å‹ã€ï¼ˆå·²åœ¨æˆé•·å»ºæ§‹ä¹‹å¾Œæª¢æŸ¥ï¼‰
  if (
    (isYellow(æ”¶å…¥ç©©å®šåº¦) || isGreen(æ”¶å…¥ç©©å®šåº¦)) &&
    isYellow(é‡‘éŒ¢ç®¡ç†) &&
    isYellow(å¿ƒç†èˆ‡è¦åŠƒ) &&
    (isOrange(å„²å‚™æ‡‰è®ŠåŠ›) || isYellow(å„²å‚™æ‡‰è®ŠåŠ›)) &&
    (isOrange(è³‡æºé€£çµ) || isYellow(è³‡æºé€£çµ)) &&
    redCount <= 1 &&
    !isRed(å¿ƒç†èˆ‡è¦åŠƒ) && // æ–°å¢å¦æ±ºï¼šå¿ƒç†ä¸å¾—ç‚º ğŸ”´
    !isRed(é‡‘éŒ¢ç®¡ç†) && // æ–°å¢å¦æ±ºï¼šé‡‘éŒ¢ç®¡ç†ä¸å¾—ç‚º ğŸ”´
    !isRed(å„²å‚™æ‡‰è®ŠåŠ›) && // æ–°å¢å¦æ±ºï¼šå„²å‚™ä¸å¾—ç‚º ğŸ”´
    !(isGreen(å¿ƒç†èˆ‡è¦åŠƒ) && isGreen(é‡‘éŒ¢ç®¡ç†))  // é¿å…èˆ‡æˆé•·å»ºæ§‹é‡ç–Š
  ) {
    return "stable"
  }

  // 7. æˆé•·å»ºæ§‹ï¼ˆgrowingï¼‰
  // ç‡ˆè™Ÿæ¢ä»¶ï¼š
  // - å¿ƒç†èˆ‡è¦åŠƒï¼šğŸŸ¢
  // - é‡‘éŒ¢ç®¡ç†ï¼šğŸŸ¡ï½ğŸŸ¢
  // - è³‡æºé€£çµï¼šğŸŸ¡ï½ğŸŸ¢
  // - å„²å‚™æ‡‰è®ŠåŠ›ï¼šğŸŸ ï½ğŸŸ¡
  // - å…­å¤§æŒ‡æ¨™ä¸­ ğŸ”´ ä¸å¾—è¶…éä¸€é …
  // æ’é™¤æ¢ä»¶ï¼šè‹¥å„²å‚™æ‡‰è®ŠåŠ›ï¼šğŸŸ¢ ä¸” é‡‘éŒ¢ç®¡ç†ï¼šğŸŸ¢ ä¸”ç„¡ ğŸ”´ï¼Œæ‡‰å¾€ä¸Šæª¢æŸ¥ã€Œæˆç†Ÿç©©å¥å‹ã€ï¼ˆå·²åœ¨æˆç†Ÿç©©å¥ä¹‹å¾Œæª¢æŸ¥ï¼‰
  if (
    isGreen(å¿ƒç†èˆ‡è¦åŠƒ) &&
    (isYellow(é‡‘éŒ¢ç®¡ç†) || isGreen(é‡‘éŒ¢ç®¡ç†)) &&
    (isYellow(è³‡æºé€£çµ) || isGreen(è³‡æºé€£çµ)) &&
    (isOrange(å„²å‚™æ‡‰è®ŠåŠ›) || isYellow(å„²å‚™æ‡‰è®ŠåŠ›)) &&
    redCount <= 1 &&
    !(isGreen(å„²å‚™æ‡‰è®ŠåŠ›) && isGreen(é‡‘éŒ¢ç®¡ç†) && redCount === 0)  // é¿å…èˆ‡æˆç†Ÿç©©å¥é‡ç–Š
  ) {
    return "growing"
  }

  // 8. æˆç†Ÿç©©å¥ï¼ˆmatureï¼‰- Strict only
  // ç‡ˆè™Ÿæ¢ä»¶ï¼š
  // - è‡³å°‘ä¸‰é …æŒ‡æ¨™ç‚º ğŸŸ¢ï¼Œä¸”éœ€åŒ…å«ä»¥ä¸‹å…©é¡ä»¥ä¸Šï¼šå„²å‚™æ‡‰è®ŠåŠ›ã€è³‡æºé€£çµã€å¿ƒç†èˆ‡è¦åŠƒ
  // - å…¶é¤˜æŒ‡æ¨™è‡³å°‘ç‚º ğŸŸ¡
  // - å…­å¤§æŒ‡æ¨™ä¸­ ğŸ”´ ç‚º 0
  // æ’é™¤æ¢ä»¶ï¼šè‹¥ä»»ä¸€æ ¸å¿ƒæ‰¿æ¥æŒ‡æ¨™ï¼ˆå„²å‚™ï¼è³‡æºï¼å¿ƒç†ï¼‰ç‚º ğŸŸ¡ ä»¥ä¸‹ï¼Œä¸å¾—åˆ¤ç‚ºæˆç†Ÿç©©å¥å‹
  const greenCount = allDimensions.filter((d) => isGreen(d)).length
  const supportDimensionsGreen = supportDimensions.filter((d) => isGreen(d)).length
  const allAtLeastYellow = allDimensions.every((d) => isYellowOrGreen(d))
  const allSupportAtLeastYellow = supportDimensions.every((d) => isYellowOrGreen(d))
  
  if (
    greenCount >= 3 &&
    supportDimensionsGreen >= 2 &&
    allAtLeastYellow &&
    allSupportAtLeastYellow &&
    redCount === 0
  ) {
    return "mature"
  }

  // ============================================
  // ç¬¬äºŒå±¤ï¼šæ‰¿æ¥å±¤åˆ¤è®€ï¼ˆFallback Resolutionï¼‰
  // ============================================
  // ç•¶ Strict Classification ç„¡ä»»ä½•çµæ§‹å‘½ä¸­æ™‚ï¼Œç³»çµ±éœ€åŸ·è¡Œä»¥ä¸‹æ‰¿æ¥é‚è¼¯ï¼š
  // ç³»çµ±å¿…é ˆä¿è­‰ï¼šè‡³å°‘å‘½ä¸­å…¶ä¸­ä¸€å€‹æ‰¿æ¥å‹ï¼Œä¸å¾—å›å‚³ UNCLASSIFIED è‡³ä½¿ç”¨è€…ç«¯
  // ============================================

  // Step 1ï½œæª¢æŸ¥ã€ŒåƒåŠ›æ”¯æ’å‹ã€æ¢ä»¶
  // - è‹¥å¤šæ•¸æŒ‡æ¨™ç‚º ğŸŸ ï¼Œä¸” ğŸ”´ â‰¤ 1
  // â†’ å›åˆ¤ç‚ºã€ŒåƒåŠ›æ”¯æ’å‹ã€
  // æ’é™¤æ¢ä»¶ï¼šè‹¥è³‡æºé€£çµ = ğŸŸ¢ï¼Œä¸å¾—åˆ¤ç‚ºåƒåŠ›æ”¯æ’å‹ï¼ˆæœ‰å¤–éƒ¨æ”¯æŒç³»çµ±ï¼Œå£“åŠ›ä¸å†å®Œå…¨ç”±å®¶åº­å…§éƒ¨æ‰¿æ“”ï¼‰
  if (!isGreen(è³‡æºé€£çµ) && orangeCount >= 3 && redCount <= 1) {
    return "struggling"
  }

  // Step 2ï½œæª¢æŸ¥ã€Œè³‡æºå¡ä½å‹ã€
  // - è‹¥è³‡æºé€£çµ â‰¥ ğŸŸ¡
  // - ä¸” å„²å‚™ / é‡‘éŒ¢ / å¿ƒç† ä¸­è‡³å°‘å…©é …ç‚º ğŸŸ  æˆ– ğŸ”´
  // â†’ å›åˆ¤ç‚ºã€Œè³‡æºå¡ä½å‹ã€
  if (isYellowOrGreen(è³‡æºé€£çµ)) {
    const weakDimensions = [å„²å‚™æ‡‰è®ŠåŠ›, é‡‘éŒ¢ç®¡ç†, å¿ƒç†èˆ‡è¦åŠƒ]
    const weakCount = weakDimensions.filter((d) => isOrangeOrRed(d)).length
    if (weakCount >= 2) {
      return "stuck"
    }
  }

  // Step 3ï½œæª¢æŸ¥ã€Œäººè„ˆæ‰¿æ¥å‹ã€
  // - è‹¥ è³‡æºé€£çµ = ğŸŸ¢ ä¸” å¿ƒç†èˆ‡è¦åŠƒ = ğŸŸ¢
  // - ä¸” å„²å‚™æ‡‰è®ŠåŠ› â‰  ğŸŸ¢
  // â†’ å›åˆ¤ç‚ºã€Œäººè„ˆæ‰¿æ¥å‹ã€
  if (isGreen(è³‡æºé€£çµ) && isGreen(å¿ƒç†èˆ‡è¦åŠƒ) && !isGreen(å„²å‚™æ‡‰è®ŠåŠ›)) {
    return "supported"
  }

  // å¦‚æœä»¥ä¸Šæ‰¿æ¥é‚è¼¯éƒ½æœªå‘½ä¸­ï¼Œå›åˆ¤ç‚ºã€ŒåƒåŠ›æ”¯æ’å‹ã€ï¼ˆæœ€çµ‚å…œåº•ï¼‰
  // æ’é™¤æ¢ä»¶ï¼šè‹¥è³‡æºé€£çµ = ğŸŸ¢ï¼Œä¸å¾—åˆ¤ç‚ºåƒåŠ›æ”¯æ’å‹ï¼Œæ”¹åˆ¤ç‚ºã€Œè³‡æºå¡ä½å‹ã€æˆ–ã€Œäººè„ˆæ‰¿æ¥å‹ã€
  // ç¢ºä¿ç³»çµ±æ°¸é åªè¼¸å‡ºä¸€å€‹å¯ç†è§£çš„çµæ§‹å‹æ…‹
  if (isGreen(è³‡æºé€£çµ)) {
    // å¦‚æœè³‡æºé€£çµ = ğŸŸ¢ï¼Œå„ªå…ˆåˆ¤ç‚ºã€Œè³‡æºå¡ä½å‹ã€æˆ–ã€Œäººè„ˆæ‰¿æ¥å‹ã€
    if (isGreen(å¿ƒç†èˆ‡è¦åŠƒ) && !isGreen(å„²å‚™æ‡‰è®ŠåŠ›)) {
      return "supported"
    }
    return "stuck"
  }
  return "struggling"
}

function determineAnimalType(
  dimensions: DimensionScores,
  answers: Record<number, number>
): AnimalType {
  // ============================================
  // ã€é›™å±¤çµæ§‹æ‰¿æ¥åˆ¤è®€æ³•ï¼ˆDSRMï¼‰â€” å‹•ç‰©æŒ‡æ¨™åˆ¤è®€ã€‘
  // ============================================
  // STEP 1. Strict Classificationï¼ˆåš´æ ¼çµæ§‹åˆ¤è®€ï¼‰
  //   â†’ è‹¥å‘½ä¸­ä»»ä¸€å‹•ç‰©ï¼Œç›´æ¥å›å‚³çµæœ
  //
  // STEP 2. Fallback Resolutionï¼ˆæ‰¿æ¥å±¤ï¼‰
  //   â†’ è‹¥ STEP 1 ç„¡å‘½ä¸­ï¼Œé€²å…¥æ‰¿æ¥å‹çµæ§‹æª¢æŸ¥
  //
  // STEP 3. Nearest-Structure Matchingï¼ˆçµæ§‹ç›¸ä¼¼åº¦æ¯”å°ï¼‰
  //   â†’ è‹¥å‰å…©å±¤éƒ½ç„¡å‘½ä¸­ï¼Œä½¿ç”¨ç›¸ä¼¼åº¦æ¯”å°
  //
  // âš ï¸ å°ä½¿ç”¨è€…æ°¸é åªå›å‚³ä¸€éš»å‹•ç‰©
  // âš ï¸ ç³»çµ±å…§å¯æ¨™è¨˜ strict / fallbackï¼Œä½†å‰ç«¯ä¸é¡¯ç¤º
  // ============================================

  const {
    æ”¶å…¥ç©©å®šåº¦,
    å„²å‚™æ‡‰è®ŠåŠ›,
    å‚µå‹™èˆ‡ä¿éšœ,
    é‡‘éŒ¢ç®¡ç†,
    è³‡æºé€£çµ,
    å¿ƒç†èˆ‡è¦åŠƒ,
  } = dimensions

  // ç‡ˆè™Ÿè½‰æ›å‡½æ•¸ï¼ˆå”¯ä¸€æ¨™æº–ï¼‰
  // ğŸ”´ 0â€“7
  // ğŸŸ  8â€“15
  // ğŸŸ¡ 16â€“23
  // ğŸŸ¢ 24â€“30

  // è¼”åŠ©å‡½æ•¸ï¼šåˆ¤æ–·åˆ†æ•¸å€é–“
  const isRed = (score: number) => score >= 0 && score <= 7
  const isOrange = (score: number) => score >= 8 && score <= 15
  const isYellow = (score: number) => score >= 16 && score <= 23
  const isGreen = (score: number) => score >= 24 && score <= 30
  const isOrangeOrRed = (score: number) => score >= 0 && score <= 15
  const isYellowOrGreen = (score: number) => score >= 16 && score <= 30

  // å…ˆå®šç¾©å…­å¤§æŒ‡æ¨™é™£åˆ—ï¼Œç”¨æ–¼æª¢æŸ¥
  const allDimensions = [æ”¶å…¥ç©©å®šåº¦, å„²å‚™æ‡‰è®ŠåŠ›, å‚µå‹™èˆ‡ä¿éšœ, é‡‘éŒ¢ç®¡ç†, è³‡æºé€£çµ, å¿ƒç†èˆ‡è¦åŠƒ]

  // å…ˆå®šç¾©å…±ç”¨è®Šæ•¸
  const hasRed = allDimensions.some((d) => isRed(d))
  const greenCount = allDimensions.filter((d) => isGreen(d)).length
  const orangeCount = allDimensions.filter((d) => isOrange(d)).length
  const yellowCount = allDimensions.filter((d) => isYellow(d)).length
  const totalRedCount = allDimensions.filter((d) => isRed(d)).length

  // å®šç¾©æ ¸å¿ƒä¸‰é …ï¼ˆç”¨æ–¼å¤šå€‹å‹•ç‰©åˆ¤å®šï¼‰
  const coreDimensions = [æ”¶å…¥ç©©å®šåº¦, å„²å‚™æ‡‰è®ŠåŠ›, å¿ƒç†èˆ‡è¦åŠƒ]
  const coreAllYellowOrGreen = coreDimensions.every((d) => isYellowOrGreen(d))

  // ============================================
  // ç¬¬ä¸€å±¤ï¼šåš´æ ¼çµæ§‹åˆ¤è®€ï¼ˆStrict Classificationï¼‰
  // ============================================

  // ğŸ± 1. è²“ï½œé«˜é¢¨éšªç–ŠåŠ å‹
  // åˆ¤å®šæ¢ä»¶ï¼ˆç¬¦åˆä»»ä¸€å³æˆç«‹ï¼‰ï¼š
  // - ğŸ”´ â‰¥ 2 ä¸” R = ğŸ”´
  // - æˆ–ï¼šR = ğŸ”´ ä¸”ï¼ˆD / L / P ä»»ä¸€ç‚º ğŸ”´ï¼‰
  // - æˆ–ï¼šã€ŒRã€Dã€Lã€Pã€ä¸­ ğŸ”´ â‰¥ 3
  // æ’ä»–ï¼šğŸŸ¢ = 0ï¼ˆä¸å¾—æœ‰ä»»ä½•ç¶ ç‡ˆï¼‰
  const criticalDimensions = [å„²å‚™æ‡‰è®ŠåŠ›, å‚µå‹™èˆ‡ä¿éšœ, è³‡æºé€£çµ, å¿ƒç†èˆ‡è¦åŠƒ] // Rã€Dã€Lã€P
  const criticalRedCount = criticalDimensions.filter((d) => isRed(d)).length
  
  if (
    greenCount === 0 && ( // æ’ä»–ï¼šğŸŸ¢ = 0
      (totalRedCount >= 2 && isRed(å„²å‚™æ‡‰è®ŠåŠ›)) || // æ¢ä»¶1ï¼šğŸ”´ â‰¥ 2 ä¸” R = ğŸ”´
      (isRed(å„²å‚™æ‡‰è®ŠåŠ›) && (isRed(å‚µå‹™èˆ‡ä¿éšœ) || isRed(è³‡æºé€£çµ) || isRed(å¿ƒç†èˆ‡è¦åŠƒ))) || // æ¢ä»¶2ï¼šR = ğŸ”´ ä¸”ï¼ˆD / L / P ä»»ä¸€ç‚º ğŸ”´ï¼‰
      criticalRedCount >= 3 // æ¢ä»¶3ï¼šã€ŒRã€Dã€Lã€Pã€ä¸­ ğŸ”´ â‰¥ 3
    )
  ) {
    return "cat"
  }

  // ğŸœ 2. èèŸ»ï½œå–®ä¸€æ”¯æ’å‹
  // å¿…è¦æ¢ä»¶ï¼ˆå…¨éƒ¨æˆç«‹ï¼‰ï¼š
  // - I â‰¥ ğŸŸ¢ æˆ– ğŸŸ¡+ï¼ˆæ”¶å…¥ç©©å®šåº¦ â‰¥ ğŸŸ¢ æˆ– â‰¥ 20ï¼‰
  // - R â‰¤ ğŸŸ ï¼ˆå„²å‚™æ‡‰è®ŠåŠ› â‰¤ ğŸŸ ï¼‰
  // - P â‰¤ ğŸŸ ï¼ˆå¿ƒç†èˆ‡è¦åŠƒ â‰¤ ğŸŸ ï¼‰
  // - L â‰¤ ğŸŸ ï¼ˆè³‡æºé€£çµ â‰¤ ğŸŸ ï¼‰
  // æ’ä»–ï¼š
  // - è‹¥åŒæ™‚ç¬¦åˆ ğŸ± â†’ æ­¸ ğŸ±ï¼ˆå·²åœ¨è²“ä¹‹å¾Œæª¢æŸ¥ï¼‰
  // - R ä¸å¾—ç‚º ğŸŸ¢
  if (
    (isGreen(æ”¶å…¥ç©©å®šåº¦) || (isYellow(æ”¶å…¥ç©©å®šåº¦) && æ”¶å…¥ç©©å®šåº¦ >= 20)) && // æ¢ä»¶1ï¼šI â‰¥ ğŸŸ¢ æˆ– ğŸŸ¡+
    isOrangeOrRed(å„²å‚™æ‡‰è®ŠåŠ›) && // æ¢ä»¶2ï¼šR â‰¤ ğŸŸ 
    !isGreen(å„²å‚™æ‡‰è®ŠåŠ›) && // æ’ä»–ï¼šR ä¸å¾—ç‚º ğŸŸ¢
    isOrangeOrRed(å¿ƒç†èˆ‡è¦åŠƒ) && // æ¢ä»¶3ï¼šP â‰¤ ğŸŸ 
    isOrangeOrRed(è³‡æºé€£çµ) // æ¢ä»¶4ï¼šL â‰¤ ğŸŸ 
  ) {
    return "ant"
  }

  // ğŸ˜ 3. å¤§è±¡ï½œçµæ§‹å‹è„†å¼±
  // å¿…è¦æ¢ä»¶ï¼š
  // - I = ğŸŸ¢
  // - R = ğŸŸ 
  // - P = ğŸ”´ æˆ– L = ğŸ”´ï¼ˆè‡³å°‘ä¸€é …ï¼‰
  // æ’ä»–ï¼š
  // - P â‰  ğŸŸ¢
  // - L â‰  ğŸŸ¢
  if (
    isGreen(æ”¶å…¥ç©©å®šåº¦) && // æ¢ä»¶1ï¼šI = ğŸŸ¢
    isOrange(å„²å‚™æ‡‰è®ŠåŠ›) && // æ¢ä»¶2ï¼šR = ğŸŸ 
    (isRed(å¿ƒç†èˆ‡è¦åŠƒ) || isRed(è³‡æºé€£çµ)) && // æ¢ä»¶3ï¼šP = ğŸ”´ æˆ– L = ğŸ”´ï¼ˆè‡³å°‘ä¸€é …ï¼‰
    !isGreen(å¿ƒç†èˆ‡è¦åŠƒ) && // æ’ä»–ï¼šP â‰  ğŸŸ¢
    !isGreen(è³‡æºé€£çµ) // æ’ä»–ï¼šL â‰  ğŸŸ¢
  ) {
    return "elephant"
  }

  // ğŸ‚ 4. ç‰›ï½œé«˜è² è·æ’æŒå‹
  // å¿…è¦æ¢ä»¶ï¼š
  // - I = ğŸŸ¢
  // - R = ğŸŸ 
  // - P = ğŸŸ¡
  // - L â‰¤ ğŸŸ 
  // æ’ä»–ï¼š
  // - ä¸å¾—æœ‰ ğŸ”´
  // - è‹¥ P â‰¤ ğŸŸ  ä¸” L â‰¤ ğŸŸ  â†’ è½‰ ğŸœï¼ˆå·²é€šé P = ğŸŸ¡ æ’é™¤ï¼‰
  // - è‹¥å…­é …çš† ğŸŸ  â†’ è½‰ ğŸªï¼ˆå·²é€šé I = ğŸŸ¢ æ’é™¤ï¼‰
  if (
    !hasRed && // æ’ä»–ï¼šä¸å¾—æœ‰ ğŸ”´
    isGreen(æ”¶å…¥ç©©å®šåº¦) && // æ¢ä»¶1ï¼šI = ğŸŸ¢
    isOrange(å„²å‚™æ‡‰è®ŠåŠ›) && // æ¢ä»¶2ï¼šR = ğŸŸ 
    isYellow(å¿ƒç†èˆ‡è¦åŠƒ) && // æ¢ä»¶3ï¼šP = ğŸŸ¡
    isOrangeOrRed(è³‡æºé€£çµ) // æ¢ä»¶4ï¼šL â‰¤ ğŸŸ 
  ) {
    return "ox"
  }

  // ğŸª CAMELï½œæ’å¾ˆä¹…çš„é§±é§ï¼ˆæ…¢æ€§å…¨é¢åƒåŠ›å‹ï¼‰- Strict only
  // å¿…è¦æ¢ä»¶ï¼š
  // - green_count == 0
  // - red_count == 0
  // - (all == ORANGE OR (orange_count == 5 AND yellow_count == 1))
  const coreOrangeCount = coreDimensions.filter((d) => isOrange(d)).length
  
  if (
    greenCount === 0 && // green_count == 0
    !hasRed && // red_count == 0
    (orangeCount === 6 || (orangeCount === 5 && yellowCount === 1)) // all == ORANGE OR (orange_count == 5 AND yellow_count == 1)
  ) {
    return "camel"
  }

  // ğŸ¢ TURTLEï½œç©©å®šå‰è¡Œçš„çƒé¾œï¼ˆæ—¥å¸¸ç©©å®šå‹ï¼‰- Strict only
  // å¿…è¦æ¢ä»¶ï¼š
  // - red_count == 0
  // - green_count == 0
  // - orange_count <= 1
  // - income >= YELLOW
  // - reserve >= YELLOW
  // - mental >= YELLOW
  const allAtLeastYellowForTurtle = allDimensions.every((d) => isYellowOrGreen(d))
  
  if (
    !hasRed && // red_count == 0
    greenCount === 0 && // green_count == 0
    orangeCount <= 1 && // orange_count <= 1
    allAtLeastYellowForTurtle && // å…­é …çš† â‰¥ ğŸŸ¡
    coreAllYellowOrGreen // income >= YELLOW, reserve >= YELLOW, mental >= YELLOW
  ) {
    return "turtle"
  }

  // ğŸ HORSEï½œç©©å¥å¥”è·‘çš„é¦¬ï¼ˆæˆç†ŸéŸŒæ€§å‹ï¼‰- Strict only
  // å¿…è¦æ¢ä»¶ï¼š
  // - green_count >= 4
  // - red_count == 0
  // - orange_count == 0
  // - count_green(reserve, resource, mental) >= 2
  const supportDimensions = [å„²å‚™æ‡‰è®ŠåŠ›, è³‡æºé€£çµ, å¿ƒç†èˆ‡è¦åŠƒ] // R / L / P
  const supportGreenCount = supportDimensions.filter((d) => isGreen(d)).length
  const allAtLeastYellow = allDimensions.every((d) => isYellowOrGreen(d))
  
  if (
    greenCount >= 4 && // green_count >= 4
    !hasRed && // red_count == 0
    orangeCount === 0 && // orange_count == 0
    supportGreenCount >= 2 && // count_green(reserve, resource, mental) >= 2
    allAtLeastYellow // å…¶é¤˜æŒ‡æ¨™è‡³å°‘ç‚º ğŸŸ¡ï¼ˆç¢ºä¿çµæ§‹å®Œæ•´ï¼‰
  ) {
    return "horse"
  }

  // ============================================
  // ç¬¬äºŒå±¤ï¼šæ‰¿æ¥å‹çµæ§‹ï¼ˆFallback Enabledï¼‰
  // ============================================
  // ä¸‹åˆ—å‹•ç‰©ï¼š
  // - å¯è¢«åš´æ ¼å‘½ä¸­
  // - ä¹Ÿå¯åœ¨ç¬¬ä¸€å±¤ç„¡å‘½ä¸­æ™‚ï¼Œç”± fallback ä½¿ç”¨
  // ============================================

  // å®šç¾©çŒ´å­ç›¸é—œè®Šæ•¸ï¼ˆæå‰å®šç¾©ï¼Œä¾›å…¶ä»–å‹•ç‰©ä½¿ç”¨ï¼‰
  const monkeyDimensions = [æ”¶å…¥ç©©å®šåº¦, å„²å‚™æ‡‰è®ŠåŠ›, é‡‘éŒ¢ç®¡ç†, å‚µå‹™èˆ‡ä¿éšœ]
  const monkeyLowCount = monkeyDimensions.filter((d) => isOrangeOrRed(d)).length
  const criticalForMonkey = [å„²å‚™æ‡‰è®ŠåŠ›, å‚µå‹™èˆ‡ä¿éšœ, é‡‘éŒ¢ç®¡ç†]
  const criticalAllYellowOrGreen = criticalForMonkey.every((d) => isYellowOrGreen(d))

  // ğŸ¦­ OTTERï½œæ°´çºï¼ˆä¾è³´å‹å®‰å…¨ç¶²ï¼‰- Fallback Enabled
  // å¿…è¦æ¢ä»¶ï¼š
  // - L = ğŸŸ¢
  // - P â‰¥ ğŸŸ¡
  // - åœ¨ I / R / M ä¸­ï¼Œâ‰¥ 2 é … â‰¤ ğŸŸ 
  // æ’ä»–ï¼š
  // - è‹¥ P = ğŸŸ¢ ä¸” L = ğŸŸ¢ â†’ è½‰ ğŸ’ï¼ˆå·²åœ¨çŒ´å­ä¹‹å¾Œæª¢æŸ¥ï¼‰
  // - ğŸ”´ â‰¥ 2 â†’ ä¸å¾—ç‚ºæ°´çº
  const financialDimensions = [æ”¶å…¥ç©©å®šåº¦, å„²å‚™æ‡‰è®ŠåŠ›, é‡‘éŒ¢ç®¡ç†] // I / R / M
  const lowFinancialCount = financialDimensions.filter((d) => isOrangeOrRed(d)).length
  
  if (
    isGreen(è³‡æºé€£çµ) && // æ¢ä»¶1ï¼šL = ğŸŸ¢
    isYellowOrGreen(å¿ƒç†èˆ‡è¦åŠƒ) && // æ¢ä»¶2ï¼šP â‰¥ ğŸŸ¡
    lowFinancialCount >= 2 && // æ¢ä»¶3ï¼šåœ¨ I / R / M ä¸­ï¼Œâ‰¥ 2 é … â‰¤ ğŸŸ 
    totalRedCount < 2 && // æ’ä»–ï¼šğŸ”´ â‰¥ 2 â†’ ä¸å¾—ç‚ºæ°´çº
    !(isGreen(å¿ƒç†èˆ‡è¦åŠƒ) && isGreen(è³‡æºé€£çµ) && lowFinancialCount >= 2) // æ’ä»–ï¼šè‹¥ P = ğŸŸ¢ ä¸” L = ğŸŸ¢ â†’ è½‰ ğŸ’
  ) {
    return "otter"
  }

  // ğŸ’ MONKEYï½œçŒ´å­ï¼ˆç¤¾æœƒéŸŒæ€§å‹ï¼‰- Fallback Enabled
  // å¿…è¦æ¢ä»¶ï¼š
  // - L = ğŸŸ¢
  // - P = ğŸŸ¢
  // - åœ¨ I / R / M / D ä¸­ï¼Œâ‰¥ 2 é … â‰¤ ğŸŸ 
  // æ’ä»–ï¼š
  // - ä¸å¾—æœ‰ ğŸ”´
  // - è‹¥ R / M / D å…¨ â‰¥ ğŸŸ¡ â†’ è½‰ ğŸ¦…ï¼ˆå·²åœ¨è€é·¹ä¹‹å¾Œæª¢æŸ¥ï¼‰
  if (
    !hasRed && // æ’ä»–ï¼šä¸å¾—æœ‰ ğŸ”´
    isGreen(è³‡æºé€£çµ) && // æ¢ä»¶1ï¼šL = ğŸŸ¢
    isGreen(å¿ƒç†èˆ‡è¦åŠƒ) && // æ¢ä»¶2ï¼šP = ğŸŸ¢
    monkeyLowCount >= 2 && // æ¢ä»¶3ï¼šåœ¨ I / R / M / D ä¸­ï¼Œâ‰¥ 2 é … â‰¤ ğŸŸ 
    !criticalAllYellowOrGreen // æ’ä»–ï¼šè‹¥ R / M / D å…¨ â‰¥ ğŸŸ¡ â†’ è½‰ ğŸ¦…
  ) {
    return "monkey"
  }

  // ğŸ¿ï¸ SQUIRRELï½œæ¾é¼ ï¼ˆä¿è­·ç¶²å‹å—å‚·ï¼‰- Fallback Enabled
  // å¿…è¦æ¢ä»¶ï¼š
  // - L = ğŸŸ¢
  // - D = ğŸŸ¢
  // - R æˆ– P è‡³å°‘ 1 é … = ğŸŸ 
  // æ’ä»–ï¼š
  // - ä¸å¾—æœ‰ ğŸ”´
  // - è‹¥ P = ğŸŸ¢ ä¸”å¼±é … â‰¥ 2 â†’ è½‰ ğŸ’ï¼ˆå·²åœ¨çŒ´å­ä¹‹å¾Œæª¢æŸ¥ï¼‰
  // - è‹¥ R = ğŸŸ¢ ä¸”å…¶é¤˜å¤šç‚º ğŸŸ¡ â†’ è½‰ ğŸ¢ï¼ˆå·²åœ¨çƒé¾œä¹‹å¾Œæª¢æŸ¥ï¼‰
  if (
    !hasRed && // æ’ä»–ï¼šä¸å¾—æœ‰ ğŸ”´
    isGreen(è³‡æºé€£çµ) && // æ¢ä»¶1ï¼šL = ğŸŸ¢
    isGreen(å‚µå‹™èˆ‡ä¿éšœ) && // æ¢ä»¶2ï¼šD = ğŸŸ¢
    (isOrange(å„²å‚™æ‡‰è®ŠåŠ›) || isOrange(å¿ƒç†èˆ‡è¦åŠƒ)) && // æ¢ä»¶3ï¼šR æˆ– P è‡³å°‘ 1 é … = ğŸŸ 
    !(isGreen(å¿ƒç†èˆ‡è¦åŠƒ) && monkeyLowCount >= 2) // æ’ä»–ï¼šè‹¥ P = ğŸŸ¢ ä¸”å¼±é … â‰¥ 2 â†’ è½‰ ğŸ’
  ) {
    return "squirrel"
  }

  // ğŸ» BEARï½œå°ç†Šï¼ˆæ¢å¾©ä¸­ç‹€æ…‹ï¼‰- Fallback Enabled
  // å¿…è¦æ¢ä»¶ï¼š
  // - L = ğŸŸ¢
  // - P = ğŸŸ¢
  // - åœ¨ I / R / M / D ä¸­ï¼šâ‰¥ 1 é … â‰¤ ğŸŸ ï¼Œâ‰¥ 1 é … â‰¥ ğŸŸ¡
  // æ’ä»–ï¼š
  // - ä¸å¾—ç¬¦åˆ ğŸ’ï¼ˆå·²åœ¨çŒ´å­ä¹‹å¾Œæª¢æŸ¥ï¼‰
  // - ä¸å¾—æœ‰ ğŸ”´
  const bearDimensions = [æ”¶å…¥ç©©å®šåº¦, å„²å‚™æ‡‰è®ŠåŠ›, é‡‘éŒ¢ç®¡ç†, å‚µå‹™èˆ‡ä¿éšœ] // I / R / M / D
  const bearLowCount = bearDimensions.filter((d) => isOrangeOrRed(d)).length
  const bearHighCount = bearDimensions.filter((d) => isYellowOrGreen(d)).length
  
  if (
    !hasRed && // æ’ä»–ï¼šä¸å¾—æœ‰ ğŸ”´
    isGreen(è³‡æºé€£çµ) && // æ¢ä»¶1ï¼šL = ğŸŸ¢
    isGreen(å¿ƒç†èˆ‡è¦åŠƒ) && // æ¢ä»¶2ï¼šP = ğŸŸ¢
    bearLowCount >= 1 && // æ¢ä»¶3ï¼šâ‰¥ 1 é … â‰¤ ğŸŸ 
    bearHighCount >= 1 && // æ¢ä»¶4ï¼šâ‰¥ 1 é … â‰¥ ğŸŸ¡
    bearLowCount < 2 // æ’ä»–ï¼šä¸å¾—ç¬¦åˆ ğŸ’ï¼ˆçŒ´å­éœ€è¦è‡³å°‘2é …â‰¤ğŸŸ ï¼‰
  ) {
    return "bear"
  }

  // ğŸ¶ DOGï½œå°ç‹—ï¼ˆå¿ƒç†å•Ÿå‹•å‹ï¼‰- Fallback Enabled
  // å¿…è¦æ¢ä»¶ï¼š
  // - P = ğŸŸ¢ æˆ– â‰¥ ğŸŸ¡
  // - R â‰¤ ğŸŸ 
  // - M â‰¤ ğŸŸ 
  // é™åˆ¶ï¼š
  // - ğŸ”´ < 2
  // æ’ä»–ï¼š
  // - è‹¥ L = ğŸŸ¢ ä¸” P = ğŸŸ¢ ä¸”å¼±é … â‰¥ 2 â†’ è½‰ ğŸ’ï¼ˆå·²åœ¨çŒ´å­ä¹‹å¾Œæª¢æŸ¥ï¼‰
  // - è‹¥ P = ğŸŸ¢ ä¸” M = ğŸŸ¢ â†’ è½‰ ğŸ¦…ï¼ˆå·²åœ¨è€é·¹ä¹‹å¾Œæª¢æŸ¥ï¼‰
  if (
    isYellowOrGreen(å¿ƒç†èˆ‡è¦åŠƒ) && // æ¢ä»¶1ï¼šP = ğŸŸ¢ æˆ– â‰¥ ğŸŸ¡
    isOrangeOrRed(å„²å‚™æ‡‰è®ŠåŠ›) && // æ¢ä»¶2ï¼šR â‰¤ ğŸŸ 
    isOrangeOrRed(é‡‘éŒ¢ç®¡ç†) && // æ¢ä»¶3ï¼šM â‰¤ ğŸŸ 
    totalRedCount < 2 && // é™åˆ¶ï¼šğŸ”´ < 2
    !(isGreen(è³‡æºé€£çµ) && isGreen(å¿ƒç†èˆ‡è¦åŠƒ) && monkeyLowCount >= 2) && // æ’ä»–ï¼šè‹¥ L = ğŸŸ¢ ä¸” P = ğŸŸ¢ ä¸”å¼±é … â‰¥ 2 â†’ è½‰ ğŸ’
    !(isGreen(å¿ƒç†èˆ‡è¦åŠƒ) && isGreen(é‡‘éŒ¢ç®¡ç†)) // æ’ä»–ï¼šè‹¥ P = ğŸŸ¢ ä¸” M = ğŸŸ¢ â†’ è½‰ ğŸ¦…
  ) {
    return "dog"
  }

  // ğŸ¦… EAGLEï½œè€é·¹ï¼ˆé«˜èƒ½åŠ›ä½å®‰å…¨ç¶²ï¼‰- Fallback Enabled
  // å¿…è¦æ¢ä»¶ï¼š
  // - mental == GREEN
  // - management == GREEN
  // - count_leq_ORANGE(reserve, debt, resource) >= 1
  // - red_count == 0
  const eagleConditionA = isOrangeOrRed(å„²å‚™æ‡‰è®ŠåŠ›) || isOrangeOrRed(å‚µå‹™èˆ‡ä¿éšœ) || isOrangeOrRed(è³‡æºé€£çµ)
  const eagleConditionB = isYellow(å„²å‚™æ‡‰è®ŠåŠ›) && isYellow(è³‡æºé€£çµ) && isGreen(å‚µå‹™èˆ‡ä¿éšœ)
  
  if (
    !hasRed && // red_count == 0
    isGreen(å¿ƒç†èˆ‡è¦åŠƒ) && // mental == GREEN
    isGreen(é‡‘éŒ¢ç®¡ç†) && // management == GREEN
    (eagleConditionA || eagleConditionB) // count_leq_ORANGE(reserve, debt, resource) >= 1
  ) {
    return "eagle"
  }

  // ============================================
  // ç¬¬ä¸‰å±¤ï¼šçµæ§‹ç›¸ä¼¼åº¦æ¯”å°ï¼ˆNearest-Structure Matchingï¼‰
  // ============================================
  // è‹¥å‰å…©å±¤éƒ½ç„¡å‘½ä¸­ï¼Œä½¿ç”¨ç›¸ä¼¼åº¦æ¯”å°
  // ç‡ˆè™Ÿè½‰æ•¸å€¼ï¼šRED = 0, ORANGE = 1, YELLOW = 2, GREEN = 3
  // ============================================
  
  // å°‡ç‡ˆè™Ÿè½‰æ›ç‚ºæ•¸å€¼
  const lightToValue = (score: number): number => {
    if (isRed(score)) return 0
    if (isOrange(score)) return 1
    if (isYellow(score)) return 2
    if (isGreen(score)) return 3
    return 0
  }

  const userVector = allDimensions.map(lightToValue)

  // å‹•ç‰©åŸå‹å‘é‡ï¼ˆæŒ‰ç…§è¦æ ¼å®šç¾©ï¼‰
  const animalPrototypes: Record<AnimalType, number[]> = {
    cat: [0, 0, 0, 1, 0, 0],      // é«˜é¢¨éšªç–ŠåŠ å‹
    ant: [3, 0, 2, 1, 1, 1],       // å–®ä¸€æ”¯æ’å‹
    elephant: [3, 1, 1, 1, 0, 0],  // çµæ§‹å‹è„†å¼±
    ox: [3, 1, 2, 2, 1, 2],        // é«˜è² è·æ’æŒå‹
    camel: [1, 1, 1, 1, 1, 1],     // æ…¢æ€§å…¨é¢åƒåŠ›å‹
    turtle: [2, 2, 2, 2, 2, 2],    // æ—¥å¸¸ç©©å®šå‹
    otter: [1, 1, 1, 1, 3, 2],     // ä¾è³´å‹å®‰å…¨ç¶²
    monkey: [1, 1, 1, 1, 3, 3],    // ç¤¾æœƒéŸŒæ€§å‹
    squirrel: [2, 1, 3, 2, 3, 1],  // ä¿è­·ç¶²å‹å—å‚·
    bear: [1, 1, 2, 2, 3, 3],      // æ¢å¾©ä¸­ç‹€æ…‹
    dog: [2, 1, 2, 1, 2, 3],       // å¿ƒç†å•Ÿå‹•å‹
    eagle: [2, 1, 2, 3, 2, 3],     // é«˜èƒ½åŠ›ä½å®‰å…¨ç¶²
    horse: [3, 3, 3, 3, 3, 3],     // æˆç†ŸéŸŒæ€§å‹
  }

  // è¨ˆç®— Manhattan distance
  const manhattanDistance = (vec1: number[], vec2: number[]): number => {
    return vec1.reduce((sum, val, i) => sum + Math.abs(val - vec2[i]), 0)
  }

  // æ‰¾å‡ºè·é›¢æœ€è¿‘çš„å‹•ç‰©
  let minDistance = Infinity
  let nearestAnimal: AnimalType = "turtle" // é è¨­ç‚ºçƒé¾œ

  for (const [animal, prototype] of Object.entries(animalPrototypes)) {
    const distance = manhattanDistance(userVector, prototype)
    if (distance < minDistance) {
      minDistance = distance
      nearestAnimal = animal as AnimalType
    }
  }

  // è¿”å›æœ€æ¥è¿‘çš„å‹•ç‰©ï¼ˆç¢ºä¿æ°¸é åªè¼¸å‡ºä¸€å€‹å¯ç†è§£çš„çµæ§‹å‹æ…‹ï¼‰
  return nearestAnimal
}

function determinePriorities(answers: Record<number, number>): string[] {
  const priorities: string[] = []

  // 1. ç·Šæ€¥ç¶“æ¿Ÿæ´åŠ©ï¼ˆé¡Œ1æˆ–é¡Œ5é¡¯ç¤ºç‹€æ…‹è¼ƒå¼±ï¼‰
  if (answers[1] <= 3 || answers[5] <= 3) {
    priorities.push("ç·Šæ€¥ç¶“æ¿Ÿæ´åŠ©")
  }

  // 2. å‚µå‹™ç®¡ç†ï¼ˆé¡Œ4é¡¯ç¤ºç‹€æ…‹è¼ƒå¼±ï¼‰
  if (answers[4] <= 3) {
    priorities.push("å‚µå‹™ç®¡ç†")
  }

  // 3. å„²è“„åŸ¹é¤Šï¼ˆé¡Œ3é¡¯ç¤ºç‹€æ…‹è¼ƒå¼±ï¼‰
  if (answers[3] <= 3) {
    priorities.push("å„²è“„åŸ¹é¤Š")
  }

  // 4. é‡‘èæ•™è‚²ï¼ˆé¡Œ7æˆ–é¡Œ8é¡¯ç¤ºç‹€æ…‹è¼ƒå¼±ï¼‰
  if (answers[7] <= 3 || answers[8] <= 3) {
    priorities.push("é‡‘èæ•™è‚²")
  }

  // 5. å°±æ¥­æ”¯æŒï¼ˆé¡Œ2é¡¯ç¤ºç‹€æ…‹è¼ƒå¼±ï¼‰
  if (answers[2] <= 3) {
    priorities.push("å°±æ¥­æ”¯æŒ")
  }

  // 6. é‡‘èæœå‹™é€£çµï¼ˆé¡Œ6é¡¯ç¤ºç‹€æ…‹è¼ƒå¼±ï¼‰
  if (answers[6] <= 3) {
    priorities.push("é‡‘èæœå‹™é€£çµ")
  }

  // 7. ç¤¾æœƒç¶²çµ¡å»ºç«‹ï¼ˆé¡Œ9é¡¯ç¤ºç‹€æ…‹è¼ƒå¼±ï¼‰
  if (answers[9] <= 3) {
    priorities.push("ç¤¾æœƒç¶²çµ¡å»ºç«‹")
  }

  // 8. å¿ƒç†æ”¯æŒï¼ˆé¡Œ10é¡¯ç¤ºç‹€æ…‹è¼ƒå¼±ï¼‰
  if (answers[10] <= 3) {
    priorities.push("å¿ƒç†æ”¯æŒ")
  }

  return priorities
}
